---
title: 'CEMiTool: Co-expression Modules Identification Tool'
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
  prettydoc::html_pretty:
    highlight: github
    theme: cayman
    toc: yes
vignette: |
  %\VignetteIndexEntry{CEMiTool: Co-expression Modules Identification Tool} %\VignetteEngine{knitr::rmarkdown} \usepackage[utf8]{inputenc}
---


```{r style, echo=FALSE, results="asis", message=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache=TRUE)
```

# Basic usage

The `CEMiTool` `R` package provides users with an easy-to-use method to automatically
implement `WGCNA` analyses with optimized parameters. In addition it performs gene set enrichment analysis and over representation analysis.

For the most basic usage of `CEMiTool` only a `data.frame` containing expression data
with gene symbols in the rows and sample names in the columns is needed, as following:

```{r}
library("CEMiTool")
# load expression data
data(expr)
head(expr[,1:4])
```

In this usage, the `cemitool` function receives the expression data, performs the `WGCNA` analysis and returns a `CEMiTool` object:
```{r, results='hide'}
cem <- cemitool(expr)
```
To see a summary of the slots inside the `CEMiTool` object we can use `print`
```{r}
print(cem)
# or, more conveniently, just call `cem`
cem
```

The `cemitool()` function automatically executes some common analyses, depending on the input data. The following sections describes how to perform each of these analyses separately.

## Gene filtering

As a default, the `cemitool` function  performs a filtering of the gene expression data before running the `WGCNA` analysis. This filtering is done in accordance to gene variance. In this example the filtering step has reduced the gene number to `r length(cem@selected_genes)`.

The filtering parameters can be adjusted in the `cemitool` functon or you can refilter an existing `CEMiTool` object with the `filter_expr(cem)` function.

## Module inspection
The WGCNA analysis has produced `r nmodules(cem)` modules and the allocation of genes to modules can be seen in the `cem@module` slot:

```{r}
# inspect modules
nmodules(cem)
head(cem@module)
```

Genes that are allocated to `Not.Correlated` are genes that are not clustered into any module.

If you wish to adjust the the module definition parameters of your `CEMiTool` object, use `find_modules(cem)`.

You can use the `get_hubs` function to identify the top `n` genes with the highest connectivity in each module: `hubs <- get_hubs(cem,n)`. 
A summary statistic of the expression data within each module (either the module mean or eigengene) can be obtained using: `summary <- mod_summary(cem)`
 
## Generating reports

The information generated by CEMiTool, including tables and images can be accessed by generating a report of a the `CEMiTool` object:
```{r, eval=FALSE}
generate_report(cem, output_format=c("pdf_document", "html_document"))
```

The report will written to the directory `./reports`.

Also, you can create tables with the analyses results using: 
```{r}
write_files(cem, directory="./reports", force=TRUE)
```

# Adding sample annotation

More information can be included in CEMiTool to build a more complete object and generate richer reports about the expression data. Sample annotation can be supplied in a `data.frame` that specifies a class for each sample. Classes can represent different conditions, phenotypes, cell lines, time points, etc. In this example, classes are defined as the time point at which the samples were collected.

```{r}
# load your sample annotation data
data(sample_annot)
head(sample_annot)
```

Now you can construct a `CEMiTool` object with both expression data and sample annotation:

```{r, results='hide'}
# run cemitool with sample annotation
cem <- cemitool(expr,sample_annot)
```

The sample annotation of your CEMiTool object can be retrieved and reassigned using the `sample_annotation` function.


## Module enrichment

When sample annotation is provided, the `cemitool` function will automatically evaluate how the modules are up or down regulated between classes. This is performed using the gene set enrichment analysis function from the `fgsea` package. 

You can generate a heatmap of how the enrichment of the modules varies across classes with the `plot_gsea` function. The size and intensity of the circles in the heatmap correspond to the Normalised Enrichment Score (NES), which is the enrichment score for a module in each class normalised by the number of genes in the module.

```{r}
# generate heatmap of gene set enrichment analysis
cem <- mod_gsea(cem)
cem <- plot_gsea(cem)
show_plot(cem, "gsea")
```

You can also peform GSEA analysis on the modules in your `CEMiTool` object using the `mod_gsea` function:

```{r}
# perform GSEA of modules across your experimental classes
cem <- mod_gsea(cem)
```

## Expression patterns in modules

You can generate a plot that displays the expression of each gene within a module using the `plot_profile` function:

```{r}
# plot gene expression within each module
cem <- plot_profile(cem)
plots <- show_plot(cem, "profile")
plots[1]
```

# Adding ORA analysis

CEMiTool can determine which biological functions are associated with the modules by performing an over representation analysis (ORA). To do this you must provide a pathway list in the form of GMT file. CEMiTool will then use the `clusterProfiler` package to see how these pathways are represented in the modules.

You can read in a pathway list formatted as a GMT file using the `read_gmt` function. This example uses a GMT file that comes as part of the `CEMiTool` example data:

```{r}
# read GMT file
gmt_fname <- system.file("extdata", "pathways.gmt", package = "CEMiTool")
gmt_in <- read_gmt(gmt_fname)
```

You can then perform ORA analysis on the modules in your `CEMiTool` object with the `mod_ora` function:

```{r}
# perform over representation analysis
cem <- mod_ora(cem, gmt_in)
```

The numerical results of the analysis can be accessed with the `ora_data` function. In order to visualise this, use `plot_ora` to add ORA plots to your `CEMiTool` object. The plots can be accessed with the `show_plot` function.

```{r}
# plot ora results
cem <- plot_ora(cem)
plots <- show_plot(cem, "ora")
plots[1]
```

# Adding interactions

Interaction data, such as protein-protein interactions can be added to the `CEMiTool` object in order to generate annotated module graphs. Interaction files are formatted as a `data.frame` or `matrix` containing two columns for interacting pairs of genes.

```{r}
# read interactions
int_fname <- system.file("extdata", "interactions.tsv", package = "CEMiTool")
int_df <- read.delim(int_fname)
head(int_df)
```

You can add the interaction data to your `CEMiTool` object using the `interactions_data` function and generate the plots with `plot_interactions`. Once again, the plots can be seen with the `show_plot` function:

```{r}
# plot interactions
library(ggplot2)
cem <- include_interactions(cem, int_df) # add interactions
cem <- plot_interactions(cem) # generate plot
plots <- show_plot(cem, "interaction") # view the plot for the first module
```

# Putting it all together...

Finally, a `CEMiTool` object with all of the components mentioned above can also be constructed using just the `cemitool` function:

```{r, eval=FALSE}
# run cemitool
library(ggplot2)
cem <- cemitool(expr, sample_annot, gmt_in, interactions=int_df, 
                filter=TRUE, plot=TRUE)
# create report
generate_report(cem, output_format=c("pdf_document", "html_document"))

# write analysis results into files
write_files(cem, directory=".", force=TRUE)
```