---
title: "CEMiTool"
output:
  html_document:
     code_folding: hide
     theme: cosmo
     self_contained: true
  pdf_document:
    toc: true
    number_sections: true
---

```{r echo=FALSE, results="asis", cache=F}

cat("#", title, "{.tabset}")


```

## Modules ##
```{r echo=FALSE, cache=F}
    mod_df <- as.data.frame(table(cem_obj@module$modules), stringsAsFactors=FALSE)
    colnames(mod_df) <- c("Module", "No.Genes")
    hub_list <- get_hubs(cem_obj, n=5)
    Hubs <- sapply(hub_list, paste, collapse=", ")
    mod_df <- merge(mod_df, as.data.frame(Hubs), by.x="Module", by.y="row.names")
    DT::datatable(mod_df, rownames=FALSE)
```



## Profile Plot
```{r echo=FALSE, fig.align="center", cache=F}
    if(length(cem_obj@profile_plot) > 0){
        .null <- lapply(cem_obj@profile_plot, print)
    } else {
        writeLines("### Please create profile plots!")
    }
```

## Gene Set Enrichment Analysis 
```{r echo=FALSE, fig.width=10, fig.align="center", cache=F}
    if(!is.null(names(cem_obj@enrichment_plot))){
        plot(cem_obj@enrichment_plot)
    } else {
        writeLines("### Please create enrichment plots!")
    }
```

```{r echo=FALSE, cache=F}
    if(length(cem_obj@enrichment) > 0){
        nes <- cem_obj@enrichment$nes
        nes[, -1] <- round(nes[, -1], digits=2)
        pv <- cem_obj@enrichment$pval
        pv[, -1] <- round(pv[, -1], digits=5)

        colnames(nes)[-1] <- paste0(colnames(nes)[-1], ": NES")
        colnames(pv)[-1] <- paste0(colnames(pv)[-1], ": p-value")

        # join p-values and nes
        enrich_df <- merge(nes, pv, by.x="pathway")

        # reorder columns
        enrich_df <- enrich_df[, c("pathway", sort(colnames(enrich_df)[-1]))]
        DT::datatable(enrich_df, rownames=FALSE)
    } else {
        writeLines("### Please run enrichment analysis!")
    }

```

## Over Representation Analysis {.tabset}
```{r echo=FALSE, results="asis", fig.align="center"}
    if(nrow(cem_obj@ora) > 0){
        columns <- c("ID", "Count", "GeneRatio", "BgRatio", "p.adjust")
        ora_df <- cem_obj@ora[, columns]
        ora_df[, "p.adjust"] <- round(ora_df[, "p.adjust"], digits=5)
        ora_list <- split(ora_df, cem_obj@ora$Module)
        there_is_barplot <- length(cem_obj@barplot_ora) > 0

        for(n in names(ora_list)){
            h3n <- paste("###", n) 
            writeLines(h3n)
            if(there_is_barplot){
                print(cem_obj@barplot_ora[[n]]$pl)
            }
            print(htmltools::tagList(DT::datatable(ora_list[[n]][1:max_rows_ora, ], 
                                                   options = list(pageLength=5), 
                                                   rownames = FALSE)))
        }
    } else {
        writeLines("### Please run over representation analysis!")
    }
```

## Interaction Network
```{r echo=FALSE, fig.align="center", cache=F, results="asis"}
    if(length(cem_obj@interaction_plot) > 0){
        x <- lapply(cem_obj@interaction_plot, print)
    } else {
        writeLines("### Please add interactions in the CEMiTool object")
    }
```

## Parameters ##
```{r echo=FALSE, cache=F}
desc <- c("cor_method" = "Correlation method.",
          "min_ngen" = "Minimum number of genes per module.",
          "merge_similar" = "Should similar modules be merged ?",
          "diss_thresh" = "Dissimilarity threshold to be used as cutoff on hierarchical cluster.",
          "r2" = "Determination coeficient. Reflects the scale-freeness of the resultant network.",
          "beta" = "Value of beta choosed.",
          "phi" = "Area under curve / Total area in the graph Beta vs R^2."
          )
params_list <- cem_obj@parameters
params_list[["r2"]] <- round(params_list[["r2"]], digits=3)
params_list[["diss_thresh"]] <- round(params_list[["diss_thresh"]], digits=3)
params_list[["phi"]] <- round(params_list[["phi"]], digits=3)
params <- data.frame(Parameter=names(params_list), 
                     Description=desc[names(params_list)],
                     Value=as.character(params_list))
DT::datatable(params, rownames=F)
```
